{% schema %}
{
  "name": "Photo Gallery",
  "settings": [
    {
      "type": "select",
      "id": "source_type",
      "label": "Image Source Type",
      "options": [
        { "value": "google_cloud", "label": "Google Cloud Storage" },
        { "value": "link_list", "label": "List of Links" }
      ],
      "default": "link_list"
    },
    {
      "type": "text",
      "id": "bucket_name",
      "label": "Google Cloud Storage Bucket Name",
      "info": "Enter the name of your Google Cloud Storage bucket"
    },
    {
      "type": "textarea",
      "id": "image_urls",
      "label": "Image URLs",
      "info": "Enter each image URL on a new line"
    },
    {
      "type": "number",
      "id": "photos_per_page",
      "label": "Photos per Page",
      "default": 20,
      "info": "Number of photos to display per page"
    }
  ],
  "presets": [
    {
      "name": "Default",
      "category": "Gallery"
    }
  ]
}
{% endschema %}

<link href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" rel="stylesheet">

<div class="photo-gallery" id="photo-gallery">
  <!-- Images will be dynamically inserted here -->
</div>

<div class="pagination" id="pagination">
  <!-- Pagination controls will be dynamically inserted here -->
</div>

<style>
    .photo-gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .gallery-item {
      flex: 1 1 calc(33.333% - 10px);
      box-sizing: border-box;
      overflow: hidden;
      position: relative;
    }
    .gallery-item img {
      width: 100%;
      height: 300px; /* Adjust height as needed */
      object-fit: cover;
    }
    @media (max-width: 768px) {
      .gallery-item {
        flex: 1 1 calc(50% - 10px);
      }
    }
    @media (max-width: 480px) {
      .gallery-item {
        flex: 1 1 100%;
      }
    }
    body {
    line-height: 1;
  }
    .fancybox-container::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3); /* Set background opacity to 0.3 */
      backdrop-filter: blur(5px);
      z-index: -1;
    }
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    .pagination button {
      margin: 0 5px;
      padding: 10px 15px;
      background-color: #000000;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    .pagination button.disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
<script>
  $(document).ready(function() {
    console.log("Document ready");

    var sourceType = `{{ section.settings.source_type }}`;
    var bucketName = `{{ section.settings.bucket_name }}`;
    var imageUrls = `{{ section.settings.image_urls }}`.trim().split("\n");
    var photosPerPage = parseInt("{{ section.settings.photos_per_page }}");
    var currentPage = 1;

    async function listImagesFromGoogleCloud() {
      const url = `https://storage.googleapis.com/storage/v1/b/${bucketName}/o?fields=items%2FmediaLink`;
      const response = await axios.get(url);
      return response.data.items.map(item => item.mediaLink);
    }

    function scrollToGallery() {
      $('html, body').animate({
        scrollTop: $('#photo-gallery').offset().top
      }, 500);
    }

    async function displayImages(page) {
      console.log("Displaying images for page:", page);

      var imageUrlsToDisplay;
      if (sourceType === "google_cloud") {
        imageUrlsToDisplay = await listImagesFromGoogleCloud();
      } else {
        imageUrlsToDisplay = imageUrls;
      }

      const start = (page - 1) * photosPerPage;
      const end = start + photosPerPage;
      const gallery = $('#photo-gallery');
      gallery.empty();

      imageUrlsToDisplay.slice(start, end).forEach(function(url) {
        console.log("Adding image URL:", url.trim());

        var galleryItem = `
          <div class="gallery-item">
            <a href="${url.trim()}" data-fancybox="gallery">
              <img src="${url.trim()}" alt="Gallery image">
            </a>
          </div>`;
        gallery.append(galleryItem);
      });

      $('[data-fancybox="gallery"]').fancybox({
        buttons: [
          "zoom",
          "close"
        ],
        mobile: {
          clickSlide: "close",
          clickOutside: "close"
        },
        afterLoad: function(instance, current) {
          instance.$refs.container.css({
            'background': 'rgba(0, 0, 0, 0.3)',
            'backdrop-filter': 'blur(5px)'
          });
        }
      });

    }

    function updatePagination(totalPages) {
      console.log("Updating pagination");

      var pagination = $('#pagination');
      pagination.empty();

      for (var i = 1; i <= totalPages; i++) {
        console.log("Creating pagination button for page:", i);

        var button = $('<button>')
          .text(i)
          .addClass(i === currentPage ? 'disabled' : '')
          .click(function() {
            var page = parseInt($(this).text());
            if (page !== currentPage) {
              currentPage = page;
              displayImages(page);
              updatePagination(totalPages);
              scrollToGallery();
            }
          });

        pagination.append(button);
      }
    }

    (async function() {
      var imageUrlsToDisplay;
      if (sourceType === "google_cloud") {
        imageUrlsToDisplay = await listImagesFromGoogleCloud();
      } else {
        imageUrlsToDisplay = imageUrls;
      }

      const totalPages = Math.ceil(imageUrlsToDisplay.length / photosPerPage);
      displayImages(currentPage);
      updatePagination(totalPages);
    })();
  });
</script>
